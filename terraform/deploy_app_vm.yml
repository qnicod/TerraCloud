version: v1.0
name: "Deploy VM in Azure DevTest Lab"

agents:
  - name: "terraform-agent"
    machine:
      type: e1-standard-2
      os_image: ubuntu2204

blocks:
  - name: "Setup"
    task:
      jobs:
        - name: "Install Terraform"
          commands:
            - checkout
            - curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -
            - sudo apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
            - sudo apt-get update && sudo apt-get install terraform

  - name: "Terraform Init & Plan"
    task:
      secrets:
        - name: "azure_credentials"
      jobs:
        - name: "Init and Plan"
          commands:
            - checkout
            - export ARM_SUBSCRIPTION_ID=${ARM_SUBSCRIPTION_ID}
            - export ARM_TENANT_ID=${ARM_TENANT_ID}
            - terraform init
            - terraform plan -out=tfplan

  - name: "Terraform Apply"
    task:
      secrets:
        - name: "azure_credentials"
      jobs:
        - name: "Apply"
          commands:
            - terraform apply "tfplan"

